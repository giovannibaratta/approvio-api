openapi: 3.0.0
info:
  title: Workflow Approval System API
  description: API for a SaaS platform that allows customers to manage approvals for generic workflows, users, and groups.
  version: 0.0.16

tags:
  - name: Authentication
    description: OIDC authentication and token management
  - name: Workflows
    description: Workflow management and approval
  - name: Workflow Templates
    description: Workflow template management
  - name: Users
    description: User management
  - name: Groups
    description: Group management
  - name: Spaces
    description: Space management
  - name: Organization Admins
    description: Organization administrator management
  - name: Workflow Actions
    description: Workflow actions and voting
  - name: Agents
    description: Agent registration and management
  - name: Roles
    description: Role template management and listing

paths:
  /auth/login:
    get:
      summary: Initiate OIDC login
      description: Initiates OIDC authentication by generating PKCE challenge and redirecting to the OIDC provider
      operationId: initiateLogin
      tags:
        - Authentication
      security: []
      responses:
        "302":
          description: Redirect to OIDC provider for authentication
        "500":
          description: Failed to initiate login
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/APIError"

  /auth/callback:
    get:
      summary: Handle OIDC callback
      description: Handles the callback from OIDC provider and redirects to success page with authorization code
      operationId: handleCallback
      tags:
        - Authentication
      security: []
      parameters:
        - name: code
          in: query
          required: true
          description: Authorization code from OIDC provider
          schema:
            type: string
        - name: state
          in: query
          required: true
          description: State parameter to prevent CSRF attacks
          schema:
            type: string
      responses:
        "302":
          description: Redirect to success page with code and state parameters
        "400":
          description: Missing required parameters
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/APIError"

  /auth/token:
    post:
      summary: Exchange authorization code for JWT token
      description: Exchanges the authorization code and state for a JWT token containing user information and roles
      operationId: exchangeToken
      tags:
        - Authentication
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TokenRequest"
      responses:
        "200":
          description: JWT token generated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TokenResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /auth/success:
    get:
      summary: Authentication success page
      description: Returns success message for completed authentication
      operationId: authSuccess
      tags:
        - Authentication
      security: []
      responses:
        "200":
          description: Authentication successful
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthMessageResponse"

  /auth/error:
    get:
      summary: Authentication error page
      description: Returns error message for failed authentication
      operationId: authError
      tags:
        - Authentication
      security: []
      responses:
        "200":
          description: Authentication failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthMessageResponse"

  /auth/info:
    get:
      summary: Get authenticated entity information
      description: Returns basic information about the authenticated entity
      operationId: getUserInfo
      tags:
        - Authentication
      responses:
        "200":
          description: Entity information retrieved successfully
          content:
            application/json:
              schema:
                type: object
                required:
                  - entityType
                properties:
                  entityType:
                    type: string
                    description: Type of the authenticated entity
                    example: "user"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /auth/agents/challenge:
    post:
      summary: Generate authentication challenge for agent
      description: |
        Creates an encrypted challenge that must be signed by the agent to obtain a token.

        **Challenge Format (Server â†’ Agent):**
        The server generates a challenge encrypted with the agent's public key. When decrypted and base64 decoded, it contains a JSON object with:
        - `audience`: string (agent name)
        - `expires_at`: ISO 8601 formatted date-time string
        - `issuer`: string (the name of the SaaS platform, e.g., "Approvio")
        - `nonce`: a random string to ensure uniqueness (the actual challenge)
      operationId: generateAgentChallenge
      tags:
        - Authentication
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AgentChallengeRequest"
      responses:
        "200":
          description: Challenge generated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AgentChallengeResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          description: Agent not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/APIError"

  /auth/agents/token:
    post:
      summary: Exchange JWT assertion for access token
      description: |
        Validates a JWT assertion and returns a JWT access token for the authenticated agent using OAuth 2.0 JWT Bearer profile (RFC 7523).

        **JWT Assertion Requirements:**
        The agent must create and sign a JWT assertion with their private key containing:
        - `iss` (issuer): Agent name
        - `sub` (subject): Agent name (same as issuer for client authentication)
        - `aud` (audience): Authorization server identifier 
        - `exp` (expiration): JWT expiration time (Unix timestamp)
        - `jti` (JWT ID): Unique nonce from the server's challenge (prevents replay attacks)
        - `iat` (issued at): JWT issued time (Unix timestamp, optional)

        **Security Notes:**
        - JWT must be signed with RS256 algorithm using the agent's private key
        - Server verifies signature using agent's registered public key
        - Each challenge nonce can only be used once (replay protection)
        - Agent identity is extracted from the JWT issuer claim
      operationId: exchangeAgentToken
      tags:
        - Authentication
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AgentTokenRequest"
      responses:
        "200":
          description: JWT token generated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AgentTokenResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          description: Invalid or expired challenge
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/APIError"
        "404":
          description: Agent not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/APIError"
        "409":
          description: Challenge already used
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/APIError"

  /agents/register:
    post:
      summary: Register a new agent
      description: Creates a new agent registration entry with generated asymmetric key pair for future authentication
      operationId: registerAgent
      tags:
        - Agents
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AgentRegistrationRequest"
      responses:
        "201":
          description: Agent registered successfully
          headers:
            Location:
              description: URL of the created agent
              schema:
                type: string
                format: uri
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AgentRegistrationResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "409":
          description: Agent with this name already exists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/APIError"

  /agents/{agentId}/roles:
    put:
      summary: Assign roles to an agent
      description: >
        Assigns standard roles to an agent by replacing all existing role assignments.
        Roles are specified by their system-defined names and scopes. The user must be authenticated
        as a human (not an agent) to use this endpoint.
      operationId: assignAgentRoles
      tags:
        - Agents
        - Roles
      parameters:
        - name: agentId
          in: path
          required: true
          description: The unique identifier (UUID) of the agent.
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RoleAssignmentRequest"
      responses:
        "204":
          description: Roles assigned successfully
        "400":
          description: Invalid request (e.g., unknown role name, invalid scope, duplicate roles)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/APIError"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          description: Forbidden - only human users can assign roles
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/APIError"
        "404":
          description: Agent not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/APIError"
    delete:
      summary: Remove roles from an agent
      description: >
        Removes specified roles from an agent. Only the roles matching both the role name and scope will be removed.
        The user must be authenticated as a human (not an agent) to use this endpoint.
      operationId: removeAgentRoles
      tags:
        - Agents
        - Roles
      parameters:
        - name: agentId
          in: path
          required: true
          description: The unique identifier (UUID) of the agent.
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RoleRemovalRequest"
      responses:
        "204":
          description: Roles removed successfully
        "400":
          description: Invalid request (e.g., unknown role name, invalid scope)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/APIError"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          description: Forbidden - only human users can remove roles
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/APIError"
        "404":
          description: Agent not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/APIError"

  /roles:
    get:
      summary: List predefined role templates
      description: Returns a list of all predefined role templates available in the system
      operationId: listRoleTemplates
      tags:
        - Roles
      responses:
        "200":
          description: List of role templates
          content:
            application/json:
              schema:
                type: object
                required:
                  - roles
                properties:
                  roles:
                    type: array
                    items:
                      $ref: "#/components/schemas/RoleTemplate"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /workflows:
    post:
      summary: Create a new workflow
      description: Creates a new workflow with approvers and rules
      operationId: createWorkflow
      tags:
        - Workflows
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/WorkflowCreate"
      responses:
        "201":
          description: Workflow created successfully
          headers:
            Location:
              description: URL of the created workflow
              schema:
                type: string
                format: uri
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
    get:
      summary: List workflows
      description: Returns a list of workflows with optional filtering
      operationId: listWorkflows
      tags:
        - Workflows
      parameters:
        - name: page
          in: query
          description: Page number for pagination
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          description: Number of results per page
          schema:
            type: integer
            default: 20
        - name: include
          in: query
          description: Comma-separated list of related objects to include in the response
          style: form
          explode: false
          schema:
            type: array
            items:
              type: string
              enum:
                - workflow-template
        - name: include-only-non-terminal-state
          in: query
          description: >
            When set to true, only workflows that are not in terminal state will be returned.
            Terminal states are: APPROVED, CANCELED, EXPIRED. Non-terminal state: EVALUATION_IN_PROGRESS.
          schema:
            type: boolean
            default: false
      responses:
        "200":
          description: List of workflows
          content:
            application/json:
              schema:
                type: object
                required:
                  - data
                  - pagination
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/Workflow"
                  pagination:
                    $ref: "#/components/schemas/Pagination"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /workflows/{workflowId}:
    get:
      summary: Get workflow details
      description: Returns the details of a specific workflow
      operationId: getWorkflow
      tags:
        - Workflows
      parameters:
        - name: workflowId
          in: path
          required: true
          description: The unique identifier of the workflow
          schema:
            type: string
        - name: include
          in: query
          description: Comma-separated list of related objects to include in the response
          style: form
          explode: false
          schema:
            type: array
            items:
              type: string
              enum:
                - workflow-template
      responses:
        "200":
          description: Workflow details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Workflow"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  /workflows/{workflowId}/vote:
    post:
      summary: Vote on a workflow
      description: Allows an authenticated entity to cast a vote (approve or veto) on a specific workflow.
      operationId: voteOnWorkflow
      tags:
        - Workflow Actions
      parameters:
        - name: workflowId
          in: path
          required: true
          description: The unique identifier of the workflow
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/WorkflowVoteRequest"
      responses:
        "200":
          description: Vote cast successfully. Returns updated workflow details.
          content:
            application/json:
              schema:
                type: object
        "400":
          description: Invalid request (e.g., voter not authorized, invalid vote type/mode).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/APIError"
        "401":
          $ref: "#/components/responses/Unauthorized"

        "404":
          $ref: "#/components/responses/NotFound"

  /workflows/{workflowId}/canVote:
    get:
      summary: Check if the current entity can vote on a workflow
      description: Determines if the authenticated entity is eligible to cast a vote on the specified workflow.
      operationId: canVoteOnWorkflow
      tags:
        - Workflow Actions
      parameters:
        - name: workflowId
          in: path
          required: true
          description: The unique identifier of the workflow.
          schema:
            type: string
      responses:
        "200":
          description: Eligibility to vote confirmed.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CanVoteResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  /users:
    post:
      summary: Create a new user
      description: Creates a new user in the system.
      operationId: createUser
      tags:
        - Users
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UserCreate"
      responses:
        "201":
          description: User created successfully
          headers:
            Location:
              description: URL of the created user
              schema:
                type: string
                format: uri
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "409":
          description: User with this email already exists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/APIError"
    get:
      summary: List users
      description: Returns a list of users
      operationId: listUsers
      tags:
        - Users
      parameters:
        - name: search
          in: query
          description: Fuzzy search term for user display name or email.
          required: false
          schema:
            type: string
        - name: page
          in: query
          description: Page number for pagination
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          description: Number of results per page
          schema:
            type: integer
            default: 20
      responses:
        "200":
          description: List of users
          content:
            application/json:
              schema:
                type: object
                required:
                  - users
                  - pagination
                properties:
                  users:
                    type: array
                    items:
                      $ref: "#/components/schemas/UserSummary"
                  pagination:
                    $ref: "#/components/schemas/Pagination"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /users/{userId}:
    get:
      summary: Get user details
      description: Returns the details of a specific user by their ID.
      operationId: getUser
      tags:
        - Users
      parameters:
        - name: userId
          in: path
          required: true
          description: The unique identifier (UUID) of the user.
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: User details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  /users/{userId}/roles:
    put:
      summary: Assign roles to a user
      description: >
        Assigns standard roles to a user by replacing all existing role assignments.
        Roles are specified by their system-defined names and scopes. The user must be authenticated
        as a human (not an agent) to use this endpoint.
      operationId: assignUserRoles
      tags:
        - Users
        - Roles
      parameters:
        - name: userId
          in: path
          required: true
          description: The unique identifier (UUID) of the user.
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RoleAssignmentRequest"
      responses:
        "204":
          description: Roles assigned successfully
        "400":
          description: Invalid request (e.g., unknown role name, invalid scope, duplicate roles)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/APIError"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          description: Forbidden - only human users can assign roles
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/APIError"
        "404":
          description: User not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/APIError"
    delete:
      summary: Remove roles from a user
      description: >
        Removes specified roles from a user. Only the roles matching both the role name and scope will be removed.
        The user must be authenticated as a human (not an agent) to use this endpoint.
      operationId: removeUserRoles
      tags:
        - Users
        - Roles
      parameters:
        - name: userId
          in: path
          required: true
          description: The unique identifier (UUID) of the user.
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RoleRemovalRequest"
      responses:
        "204":
          description: Roles removed successfully
        "400":
          description: Invalid request (e.g., unknown role name, invalid scope)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/APIError"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          description: Forbidden - only human users can remove roles
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/APIError"
        "404":
          description: User not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/APIError"

  /groups:
    post:
      summary: Create a new approver group
      description: Create a new group for organizing approvers
      operationId: createGroup
      tags:
        - Groups
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/GroupCreate"
      responses:
        "201":
          description: Group created successfully
          headers:
            Location:
              description: URL of the created group
              schema:
                type: string
                format: uri
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
    get:
      summary: List groups
      description: Returns a list of groups
      operationId: listGroups
      tags:
        - Groups
      parameters:
        - name: page
          in: query
          description: Page number for pagination
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          description: Number of results per page
          schema:
            type: integer
            default: 20
      responses:
        "200":
          description: List of groups
          content:
            application/json:
              schema:
                type: object
                properties:
                  groups:
                    type: array
                    items:
                      $ref: "#/components/schemas/Group"
                  pagination:
                    $ref: "#/components/schemas/Pagination"
                required:
                  - groups
                  - pagination
        "401":
          $ref: "#/components/responses/Unauthorized"

  /groups/{groupIdentifier}:
    get:
      summary: Get group details
      description: Returns the details of a specific group
      operationId: getGroup
      tags:
        - Groups
      parameters:
        - name: groupIdentifier
          in: path
          required: true
          description: The unique identifier of the group or the name of the group
          schema:
            type: string
      responses:
        "200":
          description: Group details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Group"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  /groups/{groupId}/entities:
    get:
      summary: List entities in a group
      description: Returns a list of all entities (users, systems, etc.) that belong to a specific group, including their roles.
      operationId: listGroupEntities
      tags:
        - Groups
        - Users
      parameters:
        - name: groupId
          in: path
          required: true
          description: The unique identifier (UUID) of the group.
          schema:
            type: string
            format: uuid
        - name: page
          in: query
          description: Page number for pagination
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          description: Number of results per page
          schema:
            type: integer
            default: 20
      responses:
        "200":
          description: List of entities in the group
          content:
            application/json:
              schema:
                type: object
                required:
                  - entities
                  - pagination
                properties:
                  entities:
                    type: array
                    items:
                      $ref: "#/components/schemas/GroupMembership"
                  pagination:
                    $ref: "#/components/schemas/Pagination"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

    post:
      summary: Add group entities
      description: Add entities (like users) within a specific group.
      operationId: addGroupEntities
      tags:
        - Groups
        - Users
      parameters:
        - name: groupId
          in: path
          required: true
          description: The unique identifier (UUID) of the group.
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AddGroupEntitiesRequest"
      responses:
        "200":
          description: Entities managed successfully. Returns updated group details.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Group"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Group not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/APIError"
        "409":
          description: Conflict detected (e.g., adding an existing member).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/APIError"
    delete:
      summary: Remove group entities
      description: Remove entities (like users) from a specific group.
      operationId: removeGroupEntities
      tags:
        - Groups
        - Users
      parameters:
        - name: groupId
          in: path
          required: true
          description: The unique identifier (UUID) of the group.
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RemoveGroupEntitiesRequest"
      responses:
        "200":
          description: Entities removed successfully. Returns updated group details.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Group"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Group not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/APIError"
        "409":
          description: Conflict detected (e.g. removing a non-member).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/APIError"

  /spaces:
    post:
      summary: Create a new space
      description: Creates a new organizational space
      operationId: createSpace
      tags:
        - Spaces
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SpaceCreate"
      responses:
        "201":
          description: Space created successfully
          headers:
            Location:
              description: URL of the created space
              schema:
                type: string
                format: uri
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "409":
          description: Space with this name already exists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/APIError"
    get:
      summary: List spaces
      description: Returns a list of spaces
      operationId: listSpaces
      tags:
        - Spaces
      parameters:
        - name: page
          in: query
          description: Page number for pagination
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          description: Number of results per page
          schema:
            type: integer
            default: 20
      responses:
        "200":
          description: List of spaces
          content:
            application/json:
              schema:
                type: object
                required:
                  - data
                  - pagination
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/Space"
                  pagination:
                    $ref: "#/components/schemas/Pagination"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /spaces/{spaceId}:
    get:
      summary: Get space details
      description: Returns the details of a specific space
      operationId: getSpace
      tags:
        - Spaces
      parameters:
        - name: spaceId
          in: path
          required: true
          description: The unique identifier of the space
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Space details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Space"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
    delete:
      summary: Delete a space
      description: Deletes a space
      operationId: deleteSpace
      tags:
        - Spaces
      parameters:
        - name: spaceId
          in: path
          required: true
          description: The unique identifier of the space
          schema:
            type: string
            format: uuid
      responses:
        "204":
          description: Space deleted successfully
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          description: Cannot delete space with active resources
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/APIError"

  /organization/{organization-name}/admins:
    post:
      summary: Add organization administrator
      description: Adds a new organization administrator by email to the specified organization
      operationId: addOrganizationAdminToOrg
      tags:
        - Organization Admins
      parameters:
        - name: organization-name
          in: path
          required: true
          description: The name or identifier of the organization
          schema:
            type: string
            example: "my-org"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/OrganizationAdminCreate"
      responses:
        "201":
          description: Organization admin added successfully
          headers:
            Location:
              description: URL of the created organization admin
              schema:
                type: string
                format: uri
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Organization not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/APIError"
        "409":
          description: Admin with this email already exists in this organization
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/APIError"
    get:
      summary: List organization administrators
      description: Returns a list of administrators for the specified organization
      operationId: listOrganizationAdminsForOrg
      tags:
        - Organization Admins
      parameters:
        - name: organization-name
          in: path
          required: true
          description: The name or identifier of the organization
          schema:
            type: string
            example: "my-org"
        - name: page
          in: query
          description: Page number for pagination
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          description: Number of results per page
          schema:
            type: integer
            default: 20
      responses:
        "200":
          description: List of organization admins for the specified organization
          content:
            application/json:
              schema:
                type: object
                required:
                  - data
                  - pagination
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/OrganizationAdmin"
                  pagination:
                    $ref: "#/components/schemas/Pagination"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Organization not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/APIError"
    delete:
      summary: Remove organization administrator
      description: Removes an organization administrator from the specified organization
      operationId: removeOrganizationAdminFromOrg
      tags:
        - Organization Admins
      parameters:
        - name: organization-name
          in: path
          required: true
          description: The name or identifier of the organization
          schema:
            type: string
            example: "my-org"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/OrganizationAdminRemove"
      responses:
        "204":
          description: Organization admin removed successfully
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  /workflow-templates:
    post:
      summary: Create a new workflow template
      description: Creates a new workflow template with approval rules, actions, and default expiry settings
      operationId: createWorkflowTemplate
      tags:
        - Workflow Templates
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/WorkflowTemplateCreate"
      responses:
        "201":
          description: Workflow template created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WorkflowTemplate"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
    get:
      summary: List workflow templates
      description: Returns a list of workflow templates with optional filtering
      operationId: listWorkflowTemplates
      tags:
        - Workflow Templates
      parameters:
        - name: page
          in: query
          description: Page number for pagination
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          description: Number of results per page
          schema:
            type: integer
            default: 20
      responses:
        "200":
          description: List of workflow templates
          content:
            application/json:
              schema:
                type: object
                required:
                  - data
                  - pagination
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/WorkflowTemplateSummary"
                  pagination:
                    $ref: "#/components/schemas/Pagination"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /workflow-templates/{templateId}:
    get:
      summary: Get workflow template details
      description: Returns the details of a specific workflow template
      operationId: getWorkflowTemplate
      tags:
        - Workflow Templates
      parameters:
        - name: templateId
          in: path
          required: true
          description: The unique identifier of the workflow template
          schema:
            type: string
      responses:
        "200":
          description: Workflow template details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WorkflowTemplate"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
  /workflow-templates/{templateName}:
    put:
      summary: Update a workflow template
      description: Updates an existing workflow template by creating a new version and optionally canceling active workflows
      operationId: updateWorkflowTemplate
      tags:
        - Workflow Templates
      parameters:
        - name: templateName
          in: path
          required: true
          description: The name of the workflow template to update
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/WorkflowTemplateUpdate"
      responses:
        "200":
          description: Workflow template updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WorkflowTemplate"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
  /workflow-templates/{templateName}/deprecate:
    post:
      summary: Deprecate a workflow template
      description: Marks a workflow template as deprecated with optional workflow cancellation
      operationId: deprecateWorkflowTemplate
      tags:
        - Workflow Templates
      parameters:
        - name: templateName
          in: path
          required: true
          description: The name of the workflow template to deprecate
          schema:
            type: string
      requestBody:
        description: Options for deprecating a workflow template.
        required: false
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/WorkflowTemplateDeprecate"
      responses:
        "200":
          description: Workflow template deprecated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WorkflowTemplate"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

components:
  schemas:
    AgentChallengeRequest:
      type: object
      required:
        - agent_name
      properties:
        agent_name:
          type: string
          description: Name of the agent requesting authentication
          example: "ci-deployment-agent"

    AgentChallengeResponse:
      type: object
      required:
        - challenge
      properties:
        challenge:
          type: string
          description: |
            Base64 encoded encrypted challenge that must be signed by the agent.

            **Decrypted Format (JSON object):**
            ```json
            {
              "audience": "agent-name",
              "expires_at": "2025-04-15T12:15:00Z",
              "issuer": "Approvio",
              "nonce": "random-string-challenge"
            }
            ```
          example: "eyJhdWRpZW5jZSI6ImNpLWRlcGxveW1lbnQtYWdlbnQiLCJleHBpcmVzX2F0IjoiMjAyNS0wNC0xNVQxMjoxNTowMFoiLCJpc3N1ZXIiOiJBcHByb3ZpbyIsIm5vbmNlIjoiYWJjZGVmZ2hpams5ODc2NTQzMjEifQ=="

    AgentRegistrationRequest:
      type: object
      required:
        - agentName
      properties:
        agentName:
          type: string
          description: Unique name for the agent (must be unique across the system)
          example: "ci-deployment-agent"
          minLength: 1
          maxLength: 1024

    AgentRegistrationResponse:
      type: object
      required:
        - agentId
        - agentName
        - publicKey
        - privateKey
        - createdAt
      properties:
        agentId:
          type: string
          format: uuid
          description: Unique identifier for the registered agent
          example: "a1b2c3d4-e5f6-7890-1234-567890abcdef"
        agentName:
          type: string
          description: Name of the registered agent
          example: "ci-deployment-agent"
        publicKey:
          type: string
          description: RSA public key in base64 encoded PEM format for the agent
          example: "LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FROEFNSUlCQ2dLQ0FRRUEuLi4KLS0tLS1FTkQgUFVCTElDIEtFWS0tLS0t"
        privateKey:
          type: string
          description: RSA private key in base64 encoded PEM format for the agent (store securely!)
          example: "LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JSUVWd0lCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktnZ2dnU2tBZ0VBQW9JQkFRQy4uLgotLS0tLUVORCBQUklWQVRFIEtFWS0tLS0t"
        createdAt:
          type: string
          format: date-time
          description: Timestamp when the agent was registered
          readOnly: true
          example: "2025-04-15T12:05:00Z"

    AgentTokenRequest:
      type: object
      required:
        - grant_type
        - client_assertion_type
        - client_assertion
      properties:
        grant_type:
          type: string
          description: OAuth 2.0 grant type for JWT Bearer profile
          enum:
            - "urn:ietf:params:oauth:grant-type:jwt-bearer"
          example: "urn:ietf:params:oauth:grant-type:jwt-bearer"
        client_assertion_type:
          type: string
          description: OAuth 2.0 client assertion type for JWT Bearer profile
          enum:
            - "urn:ietf:params:oauth:client-assertion-type:jwt-bearer"
          example: "urn:ietf:params:oauth:client-assertion-type:jwt-bearer"
        client_assertion:
          type: string
          description: |
            JWT assertion signed with the agent's private key using RS256 algorithm.

            **JWT Header:**
            ```json
            {
              "alg": "RS256",
              "typ": "JWT"
            }
            ```

            **JWT Payload:**
            ```json
            {
              "iss": "agent-name",
              "sub": "agent-name", 
              "aud": "authorization-server-identifier",
              "exp": 1640995200,
              "jti": "nonce-from-challenge",
              "iat": 1640991600
            }
            ```

            **Requirements:**
            - Must be signed with agent's private key using RS256
            - JWT ID (jti) must match nonce from server's challenge
            - Issuer (iss) and subject (sub) must be the agent name
            - Audience (aud) must be the authorization server identifier
            - Agent identity is extracted from the issuer claim
          example: "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJpc3MiOiJjaS1kZXBsb3ltZW50LWFnZW50Iiwic3ViIjoiY2ktZGVwbG95bWVudC1hZ2VudCIsImF1ZCI6IkFwcHJvdmlvIiwiZXhwIjoxNjQwOTk1MjAwLCJqdGkiOiJhYmNkZWZnaGlqazk4NzY1NDMyMSIsImlhdCI6MTY0MDk5MTYwMH0.signature"

    AgentTokenResponse:
      type: object
      required:
        - token
      properties:
        token:
          type: string
          description: JWT token for the authenticated agent
          example: "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJjaS1kZXBsb3ltZW50LWFnZW50IiwiZW50aXR5VHlwZSI6ImFnZW50IiwiaWF0IjoxNjc4OTAxMjAwLCJleHAiOjE2Nzg5ODc2MDB9.signature"

    RoleTemplate:
      type: object
      required:
        - name
        - permissions
        - scope
      properties:
        name:
          type: string
          description: Unique identifier for the role template
          example: "GroupReadOnly"
        permissions:
          type: array
          items:
            type: string
          description: List of permissions granted by this role
          example: ["read"]
        scope:
          type: string
          x-extensible-enum:
            - org
            - space
            - group
            - workflow_template
          description: The scope type this role applies to
          example: "group"

    RoleScope:
      description: >
        Defines the scope where a role applies. Can be organization-wide, space-specific, 
        group-specific, or workflow template-specific.
      oneOf:
        - $ref: "#/components/schemas/OrgScope"
        - $ref: "#/components/schemas/SpaceScope"
        - $ref: "#/components/schemas/GroupScope"
        - $ref: "#/components/schemas/WorkflowTemplateScope"
      discriminator:
        propertyName: type
        mapping:
          org: "#/components/schemas/OrgScope"
          space: "#/components/schemas/SpaceScope"
          group: "#/components/schemas/GroupScope"
          workflow_template: "#/components/schemas/WorkflowTemplateScope"

    OrgScope:
      type: object
      description: Organization-wide scope - applies to entire organization
      required:
        - type
      properties:
        type:
          type: string
          enum: [org]
          description: Scope type (org)

    SpaceScope:
      type: object
      description: Space-specific scope - applies to a specific space
      required:
        - type
        - spaceId
      properties:
        type:
          type: string
          enum: [space]
          description: Scope type (space)
        spaceId:
          type: string
          format: uuid
          description: The unique identifier of the space
          example: "a1b2c3d4-e5f6-7890-1234-567890abcdef"

    GroupScope:
      type: object
      description: Group-specific scope - applies to a specific group
      required:
        - type
        - groupId
      properties:
        type:
          type: string
          enum: [group]
          description: Scope type (group)
        groupId:
          type: string
          format: uuid
          description: The unique identifier of the group
          example: "a1b2c3d4-e5f6-7890-1234-567890abcdef"

    WorkflowTemplateScope:
      type: object
      description: Workflow template-specific scope - applies to a specific workflow template
      required:
        - type
        - workflowTemplateId
      properties:
        type:
          type: string
          enum: [workflow_template]
          description: Scope type (workflow_template)
        workflowTemplateId:
          type: string
          format: uuid
          description: The unique identifier of the workflow template
          example: "a1b2c3d4-e5f6-7890-1234-567890abcdef"

    RoleOperationItem:
      type: object
      description: >
        A role operation item that references a system-defined role by name and provides
        the scope where it should apply (for assignment or removal).
      required:
        - roleName
        - scope
      properties:
        roleName:
          type: string
          description: >
            Name of the system-defined role template (e.g., "GroupReadOnly", "SpaceManager").
            Must match a role available from the /roles endpoint.
          example: "GroupReadOnly"
        scope:
          $ref: "#/components/schemas/RoleScope"

    RoleOperationRequest: &RoleOperationRequest
      type: object
      description: Request to assign or remove roles from a user or agent
      required:
        - roles
      properties:
        roles:
          type: array
          items:
            $ref: "#/components/schemas/RoleOperationItem"
          description: Array of role assignments specifying role names and their scopes
          example:
            - roleName: "GroupReadOnly"
              scope:
                type: "group"
                groupId: "a1b2c3d4-e5f6-7890-1234-567890abcdef"

    RoleAssignmentRequest: *RoleOperationRequest

    RoleRemovalRequest: *RoleOperationRequest

    TokenRequest:
      type: object
      required:
        - code
        - state
      properties:
        code:
          type: string
          description: Authorization code received from OIDC provider
          example: "auth_code_123"
        state:
          type: string
          description: State parameter used for CSRF protection
          example: "state_123"

    TokenResponse:
      type: object
      required:
        - token
      properties:
        token:
          type: string
          description: JWT token containing user information and roles
          example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."

    AuthMessageResponse:
      type: object
      required:
        - message
      properties:
        message:
          type: string
          description: Authentication status message
          example: "Authentication successful. Use the code and state to generate a JWT token."

    SpaceCreate:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          description: Name of the space (max 255 characters)
          example: "Engineering Team"
        description:
          type: string
          description: Description of the space (max 2048 characters)
          example: "Space for engineering team collaboration"

    Space:
      type: object
      required:
        - id
        - name
        - createdAt
        - updatedAt
      properties:
        id:
          type: string
          format: uuid
          description: Unique identifier for the space
          readOnly: true
          example: "a1b2c3d4-e5f6-7890-1234-567890abcdef"
        name:
          type: string
          description: Name of the space (max 255 characters)
          example: "Engineering Team"
        description:
          type: string
          description: Description of the space (max 2048 characters)
          example: "Space for engineering team collaboration"
        createdAt:
          type: string
          format: date-time
          description: Timestamp when the space was created
          readOnly: true
          example: "2025-04-15T12:05:00Z"
        updatedAt:
          type: string
          format: date-time
          description: Timestamp when the space was last updated
          readOnly: true
          example: "2025-04-15T12:05:00Z"

    OrganizationAdminCreate:
      type: object
      required:
        - email
      properties:
        email:
          type: string
          format: email
          description: Email address of the organization administrator
          example: "admin@example.com"

    OrganizationAdmin:
      type: object
      required:
        - userId
        - email
        - createdAt
      properties:
        userId:
          type: string
          format: uuid
          description: Unique identifier of the user who is an organization admin
          readOnly: true
          example: "a1b2c3d4-e5f6-7890-1234-567890abcdef"
        email:
          type: string
          format: email
          description: Email address of the organization administrator
          example: "admin@example.com"
        createdAt:
          type: string
          format: date-time
          description: Timestamp when the admin was created
          readOnly: true
          example: "2025-04-15T12:05:00Z"

    OrganizationAdminRemove:
      type: object
      required:
        - userId
      properties:
        userId:
          type: string
          format: uuid
          description: The unique identifier of the user to remove from organization admins
          example: "a1b2c3d4-e5f6-7890-1234-567890abcdef"

    UserSummary:
      type: object
      required:
        - id
        - displayName
        - email
      properties:
        id:
          type: string
          format: uuid
          description: Internal unique identifier for the user.
          readOnly: true
          example: "a1b2c3d4-e5f6-7890-1234-567890abcdef"
        displayName:
          type: string
          description: User's display name.
          example: "Alex Chen"
        email:
          type: string
          format: email
          description: User's email address.
          example: "alex.chen@example.com"
    UserCreate:
      type: object
      required:
        - displayName
        - email
        - orgRole
      properties:
        displayName:
          type: string
          description: User's display name.
          example: "Alex Chen"
        email:
          type: string
          format: email
          description: User's email address (must be unique).
          example: "alex.chen@example.com"
        orgRole:
          type: string
          x-extensible-enum:
            - admin
            - member
          description: Role assigned to the user within the organization.
          example: "member"
    User:
      type: object
      required:
        - id
        - displayName
        - email
        - orgRole
        - createdAt
      properties:
        id:
          type: string
          format: uuid
          description: Internal unique identifier for the user.
          readOnly: true
          example: "a1b2c3d4-e5f6-7890-1234-567890abcdef"
        displayName:
          type: string
          description: User's display name.
          example: "Alex Chen"
        email:
          type: string
          format: email
          description: User's email address.
          example: "alex.chen@example.com"
        orgRole:
          type: string
          x-extensible-enum:
            - admin
            - member
          description: Role assigned to the user within the organization.
          example: "member"
        createdAt:
          type: string
          format: date-time
          description: Timestamp when the user was created.
          readOnly: true
          example: "2025-04-15T12:05:00Z"

    EntityReference:
      type: object
      required:
        - entityType
        - entityId
      properties:
        entityType:
          type: string
          x-extensible-enum:
            - human
            - system
          description: The type of the entity being referenced.
          example: human
        entityId:
          type: string
          format: uuid
          description: The unique identifier (UUID) of the entity.
          example: "a1b2c3d4-e5f6-7890-1234-567890abcdef"

    EntityMembershipAdd:
      type: object
      required:
        - entity
      properties:
        entity:
          $ref: "#/components/schemas/EntityReference"

    EntityMembershipRemove:
      type: object
      required:
        - entity
      properties:
        entity:
          $ref: "#/components/schemas/EntityReference"

    AddGroupEntitiesRequest:
      type: object
      description: Defines operations to add entities within a group
      required:
        - entities
      properties:
        entities:
          type: array
          items:
            $ref: "#/components/schemas/EntityMembershipAdd"
          description: List of entities to add to the group.

    RemoveGroupEntitiesRequest:
      type: object
      description: Defines operations to remove entities within a group
      required:
        - entities
      properties:
        entities:
          type: array
          items:
            $ref: "#/components/schemas/EntityMembershipRemove"
          description: List of entities to remove from the group.

    GroupMembership:
      type: object
      required:
        - entity
        - addedAt
      properties:
        entity:
          $ref: "#/components/schemas/EntityReference"
        addedAt:
          type: string
          format: date-time
          description: Timestamp when the entity was added to the group.
          readOnly: true
          example: "2025-04-16T10:30:00Z"

    WorkflowTemplateSummary:
      type: object
      required:
        - id
        - name
        - version
        - createdAt
        - updatedAt
      properties:
        id:
          type: string
          format: uuid
          description: Internal unique identifier for the workflow template.
          readOnly: true
          example: "a1b2c3d4-e5f6-7890-1234-567890abcdef"
        name:
          type: string
          description: User-friendly name for the workflow template.
          example: "New Workflow Template"
        version:
          type: string
          description: Version of the workflow template.
          example: "1"
        description:
          type: string
          description: Detailed description of the workflow template.
          example: "This is a new workflow template"
        createdAt:
          type: string
          format: date-time
          description: Timestamp when the workflow template was created.
          readOnly: true
          example: "2025-04-15T12:05:00Z"
        updatedAt:
          type: string
          format: date-time
          description: Timestamp when the workflow template was last updated.
          readOnly: true
          example: "2025-04-15T12:05:00Z"

    WorkflowCreate:
      type: object
      required:
        - name
        - workflowTemplateId
      properties:
        name:
          type: string
          description: User-friendly name for the workflow
        description:
          type: string
          description: Detailed description of the workflow
        metadata:
          type: object
          description: Additional custom metadata for the workflow
        workflowTemplateId:
          type: string
          format: uuid
          description: The unique identifier of the workflow template to use as parent

    Workflow:
      type: object
      required:
        - id
        - name
        - status
        - workflowTemplateId
        - metadata
        - createdAt
        - updatedAt
      properties:
        id:
          type: string
          description: Unique identifier for the workflow
        name:
          type: string
          description: User-friendly name for the workflow
        description:
          type: string
          description: Detailed description of the workflow
        status:
          type: string
          x-extensible-enum:
            - APPROVED
            - REJECTED
            - CANCELED
            - EVALUATION_IN_PROGRESS
            - EXPIRED
          description: Current status of the workflow
        workflowTemplateId:
          type: string
          format: uuid
          description: The unique identifier of the workflow template used as parent
        metadata:
          type: object
          description: Additional custom metadata for the workflow
        ref:
          type: object
          description: Referenced objects (optional, controlled by include query parameters)
          properties:
            workflowTemplate:
              $ref: "#/components/schemas/WorkflowTemplate"
        createdAt:
          type: string
          format: date-time
          description: Creation timestamp
        updatedAt:
          type: string
          format: date-time
          description: Last update timestamp
        expiresAt:
          type: string
          format: date-time
          description: Expiry timestamp
          readOnly: true
          example: "2025-04-15T12:05:00Z"

    ApprovalRule:
      description: >
        Configuration of approval rules. Can be a boolean operator (AND/OR)
        combining nested rules, or a specific requirement (minimum count from
        a group).
      oneOf:
        - $ref: "#/components/schemas/AndRule"
        - $ref: "#/components/schemas/OrRule"
        - $ref: "#/components/schemas/GroupRequirementRule"
      discriminator:
        propertyName: type
        mapping:
          AND: "#/components/schemas/AndRule"
          OR: "#/components/schemas/OrRule"
          GROUP_REQUIREMENT: "#/components/schemas/GroupRequirementRule"

    AndRule:
      type: object
      description: An AND rule requiring all nested rules to be satisfied.
      required:
        - type
        - rules
      properties:
        type:
          type: string
          enum: [AND]
          description: Rule type (AND)
        rules:
          type: array
          description: List of rules that must all be satisfied. Cannot be empty.
          minItems: 1
          items:
            $ref: "#/components/schemas/ApprovalRule"

    OrRule:
      type: object
      description: An OR rule requiring at least one of the nested rules to be satisfied.
      required:
        - type
        - rules
      properties:
        type:
          type: string
          enum: [OR]
          description: Rule type (OR)
        rules:
          type: array
          description: List of rules where at least one must be satisfied. Cannot be empty.
          minItems: 1
          items:
            $ref: "#/components/schemas/ApprovalRule"

    GroupRequirementRule:
      type: object
      description: Requires a minimum number of approvals from a specific group.
      required:
        - type
        - groupId
        - minCount
      properties:
        type:
          type: string
          enum: [GROUP_REQUIREMENT]
          description: Rule type (GROUP_REQUIREMENT)
        groupId:
          type: string
          description: ID of the approver group.
        minCount:
          type: integer
          description: Minimum number of approvals required from the group. Must be at least 1.
          minimum: 1

    GroupCreate:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          description: Name of the group
        description:
          type: string
          description: Description of the group

    Group:
      type: object
      required:
        - id
        - name
        - entitiesCount
        - createdAt
        - updatedAt
      properties:
        id:
          type: string
          format: uuid
          description: Unique identifier for the group
        name:
          type: string
          description: Name of the group
        description:
          type: string
          description: Description of the group
        entitiesCount:
          type: integer
          description: Number of entities in the group
        createdAt:
          type: string
          format: date-time
          description: Creation timestamp
        updatedAt:
          type: string
          format: date-time
          description: Last update timestamp

    Pagination:
      type: object
      required:
        - total
        - page
        - limit
      properties:
        total:
          type: integer
          description: Total number of items
        page:
          type: integer
          description: Current page number
        limit:
          type: integer
          description: Items per page

    APIError:
      type: object
      properties:
        code:
          type: string
          description: Error code
        message:
          type: string
          description: Error message
        details:
          type: array
          items:
            type: object
            properties:
              field:
                type: string
              message:
                type: string

    WorkflowVoteRequest:
      type: object
      title: WorkflowVoteRequest
      required:
        - voteType
      properties:
        reason:
          type: string
          description: Optional reason for the vote. Can be used for approval comments or reject reasons.
          example: "Missing critical information or LGTM!"
        voteType:
          oneOf:
            - $ref: "#/components/schemas/VoteApprove"
            - $ref: "#/components/schemas/VoteVeto"
            - $ref: "#/components/schemas/VoteWithdraw"
          discriminator:
            propertyName: type
            mapping:
              APPROVE: "#/components/schemas/VoteApprove"
              VETO: "#/components/schemas/VoteVeto"
              WITHDRAW: "#/components/schemas/VoteWithdraw"

    CanVoteResponse:
      type: object
      title: CanVoteResponse
      required:
        - canVote
        - voteStatus
      properties:
        canVote:
          type: boolean
          description: True if the authenticated entity can currently vote on the workflow, false otherwise.
        voteStatus:
          type: string
          x-extensible-enum:
            - ALREADY_VOTED
            - VOTE_PENDING
          description: |
            Indicates the voting status for the user on this workflow.
          example: VOTE_PENDING
        cantVoteReason:
          type: string
          description: Reason why the entity cannot vote on the workflow. The value is only set if 'canVote' is false.
          x-extensible-enum:
            - WORKFLOW_EXPIRED
            - WORKFLOW_APPROVED
            - WORKFLOW_CANCELED
            - NOT_ELIGIBLE_TO_VOTE
    VoteApprove:
      type: object
      required:
        - type
        - votedForGroups
      properties:
        type:
          type: string
          enum: [APPROVE]
          description: Vote type (APPROVE)
        votedForGroups:
          type: array
          items:
            type: string
            format: uuid
          description: >
            List of group IDs the vote is cast for. The voter must be a member of these groups
            with appropriate role (approver, admin, or owner) to cast votes for them.
          example: ["a1b2c3d4-e5f6-7890-1234-567890abcdef"]

    VoteVeto:
      type: object
      required:
        - type
      properties:
        type:
          type: string
          enum: [VETO]
          description: Vote type (VETO)

    VoteWithdraw:
      type: object
      required:
        - type
      properties:
        type:
          type: string
          enum: [WITHDRAW]
          description: Vote type (WITHDRAW)

    WorkflowTemplateCreate:
      type: object
      required:
        - name
        - approvalRule
        - spaceId
      properties:
        name:
          type: string
          description: User-friendly name for the workflow template
        description:
          type: string
          description: Detailed description of the workflow template
        metadata:
          type: object
          description: Additional custom metadata for the workflow template
        approvalRule:
          $ref: "#/components/schemas/ApprovalRule"
        actions:
          type: array
          items:
            $ref: "#/components/schemas/WorkflowAction"
          description: Actions to be executed when workflow is approved
        defaultExpiresInHours:
          type: integer
          minimum: 1
          maximum: 8760
          description: Default expiry time for workflows created from this template (in hours, max 1 year)
        spaceId:
          type: string
          format: uuid
          description: ID of the space to which this workflow template belongs

    WorkflowTemplate:
      type: object
      required:
        - id
        - name
        - version
        - status
        - allowVotingOnDeprecatedTemplate
        - approvalRule
        - spaceId
        - createdAt
        - updatedAt
      properties:
        id:
          type: string
          description: Unique identifier for the workflow template
        name:
          type: string
          description: User-friendly name for the workflow template
        version:
          type: string
          description: Version of the workflow template. "latest" for active templates, numeric for versioned templates
        description:
          type: string
          description: Detailed description of the workflow template
        status:
          type: string
          enum:
            - ACTIVE
            - PENDING_DEPRECATION
            - DEPRECATED
          description: >
            Lifecycle status of the template:
            * ACTIVE - Template can be referenced to create new workflows
            * PENDING_DEPRECATION - Template has been deprecated but there are still active workflows (intermediate status for async deprecation)
            * DEPRECATED - Template cannot be referenced for new workflows, voting may still be allowed based on settings
        allowVotingOnDeprecatedTemplate:
          type: boolean
          description: Whether voting is allowed on workflows using this template when it's deprecated
        approvalRule:
          $ref: "#/components/schemas/ApprovalRule"
        metadata:
          type: object
          description: Additional custom metadata for the workflow template
        actions:
          type: array
          items:
            $ref: "#/components/schemas/WorkflowAction"
          description: Actions to be executed when workflow is approved
        defaultExpiresInHours:
          type: integer
          minimum: 1
          maximum: 8760
          description: Default expiry time for workflows created from this template (in hours, max 1 year)
        spaceId:
          type: string
          format: uuid
          description: ID of the space to which this workflow template belongs
        createdAt:
          type: string
          format: date-time
          description: Creation timestamp
        updatedAt:
          type: string
          format: date-time
          description: Last update timestamp

    WorkflowTemplateUpdate:
      type: object
      properties:
        description:
          type: string
          description: Detailed description of the workflow template
        metadata:
          type: object
          description: Additional custom metadata for the workflow template
        approvalRule:
          $ref: "#/components/schemas/ApprovalRule"
        actions:
          type: array
          items:
            $ref: "#/components/schemas/WorkflowAction"
          description: Actions to be executed when workflow is approved
        defaultExpiresInHours:
          type: integer
          minimum: 1
          maximum: 8760
          description: Default expiry time for workflows created from this template (in hours, max 1 year)
        cancelWorkflows:
          type: boolean
          description: >
            If true, all in-progress workflows associated with this template will be canceled when creating a new version.
            This affects the allowVotingOnDeprecatedTemplate setting: when true, voting is disabled on the deprecated template.
          default: false

    WorkflowAction:
      description: >
        Configuration for actions to be executed when workflow is approved.
        Currently supports email actions.
      oneOf:
        - $ref: "#/components/schemas/EmailAction"
      discriminator:
        propertyName: type
        mapping:
          EMAIL: "#/components/schemas/EmailAction"

    EmailAction:
      type: object
      description: Sends an email when workflow is approved
      required:
        - type
        - recipients
      properties:
        type:
          type: string
          enum: [EMAIL]
          description: Action type (EMAIL)
        recipients:
          type: array
          items:
            type: string
            format: email
          description: List of email addresses to send the notification to
          minItems: 1
          maxItems: 5

    WorkflowTemplateDeprecate:
      type: object
      properties:
        cancelWorkflows:
          type: boolean
          description: >
            If true, all in-progress workflows associated with this template will be canceled.
            This affects the allowVotingOnDeprecatedTemplate setting: when true, voting is disabled on the deprecated template.
          default: false

  responses:
    BadRequest:
      description: Invalid request
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/APIError"
    Unauthorized:
      description: Authentication required
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/APIError"
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/APIError"

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: >
        JWT token containing authentication information for users or agents.

        The JWT payload includes:
        - Core JWT claims: iss (issuer), sub (subject ID), aud (audience), exp/iat/nbf (time claims), jti (token ID)
        - Standard claims: email (for users), name (display name)
        - Custom claims: entityType ("user" or "agent")

        Users must have a valid email, while agents do not require an email field.
        Permissions and roles are resolved server-side and not included in the token for security.

security:
  - bearerAuth: []
